## Doctor Conversion
SELECT A."Doctor", 
       A. "Count of Patients Advised DHI", 
        coalesce("Count of Patients Taken DHI",0) "Count of Patients Taken DHI", 
        coalesce("Count of Patients Taken DHI"/"Count of Patients Advised DHI",0) AS "% Converted"

FROM

(SELECT
 "SNAME" AS "Doctor",
  count(distinct "LTHMS"."ADVICETYPE"."PATID") "Count of Patients Advised DHI"
FROM
  "LTHMS"."ADVICETYPE"
 
LEFT JOIN "RECEIPTDETAIL" ON "RECEIPTDETAIL"."BILLNO" = "ADVICETYPE"."BILLNO"
  LEFT JOIN "CLINICPERSONNEL" ON "CLINICPERSONNEL"."SID" = "RECEIPTDETAIL"."SID"

WHERE (LOWER("LTHMS"."ADVICETYPE"."OPERATION") LIKE '%dhi%')
   AND ADVICETYPE."ADVDATE" BETWEEN TO_DATE('2024-01-01', 'YYYY-MM-DD') AND TO_DATE('2024-12-31', 'YYYY-MM-DD')

GROUP BY "SNAME")A

LEFT JOIN

(SELECT
 "SNAME" AS "Doctor",
  count(distinct "PATID") "Count of Patients Taken DHI"
FROM
  "LTHMS"."OPTCHARGEDETAIL"
  LEFT JOIN "CLINICPERSONNEL" ON "CLINICPERSONNEL"."SID" = "OPTCHARGEDETAIL"."SID"

WHERE ( (
        LOWER("LTHMS"."OPTCHARGEDETAIL"."RPATTYPE") LIKE '%dhi%'
      )
     
   
    OR ("LTHMS"."OPTCHARGEDETAIL"."RPATTYPE" IS NULL)) 

AND "PATID" IN (SELECT DISTINCT "PATID" FROM "LTHMS"."ADVICETYPE" WHERE (LOWER("LTHMS"."ADVICETYPE"."OPERATION") LIKE '%dhi%')
AND ADVICETYPE."ADVDATE" BETWEEN TO_DATE('2024-01-01', 'YYYY-MM-DD') AND TO_DATE('2024-12-31', 'YYYY-MM-DD') ) 
AND OPTCHARGEDETAIL."BILLDATE" BETWEEN TO_DATE('2024-01-01', 'YYYY-MM-DD') AND TO_DATE('2024-12-31', 'YYYY-MM-DD')

GROUP BY "SNAME")B ON B."Doctor" = A."Doctor";
